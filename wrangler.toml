# Cloudflare Container Manager - Production Configuration
# Custom domain: container.adamic.tech

name = "container-manager"
main = "worker/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Smart Placement disabled for SPA - UI responsiveness priority
placement = { mode = "off" }

[build]
command = "npm run build"
cwd = "."

[assets]
directory = "dist"
binding = "ASSETS"

# ============================================
# D1 METADATA DATABASE CONFIGURATION
# ============================================
# This database stores container metadata, jobs, webhooks, schedules, and snapshots
# Create database: wrangler d1 create container-manager-metadata
# Then run: wrangler d1 execute container-manager-metadata --remote --file=worker/schema.sql
[[d1_databases]]
binding = "METADATA"
database_name = "container-manager-metadata"
database_id = "ead87abe-1b93-4a1f-951e-698433fc8814"

# ============================================
# R2 SNAPSHOT BUCKET
# ============================================
# R2 bucket for container configuration snapshots
# Create bucket: wrangler r2 bucket create container-manager-snapshots
[[r2_buckets]]
binding = "SNAPSHOT_BUCKET"
bucket_name = "container-manager-snapshots"

# ============================================
# CONTAINERS (Real container for testing)
# ============================================
[[containers]]
class_name = "HelloWorld"
image = "./containers/hello-world/Dockerfile"
max_instances = 3

# ============================================
# DURABLE OBJECTS
# ============================================
# HelloWorld container binding
[[durable_objects.bindings]]
name = "HELLO_WORLD"
class_name = "HelloWorld"

# Durable Object for async snapshot operations
[[durable_objects.bindings]]
name = "SNAPSHOT_DO"
class_name = "SnapshotDO"
script_name = "container-manager"

[[migrations]]
tag = "v1_snapshot_do"
new_classes = ["SnapshotDO"]

[[migrations]]
tag = "v2_hello_world"
new_sqlite_classes = ["HelloWorld"]

# ============================================
# SCHEDULED ACTIONS
# ============================================
# Cron trigger for scheduled container actions (restart, rebuild, scale)
# Runs every 15 minutes to check for and execute due scheduled actions
[triggers]
crons = ["*/15 * * * *"]

# ============================================
# OBSERVABILITY
# ============================================
[observability]
enabled = true

[observability.logs]
enabled = true

# ============================================
# CUSTOM DOMAIN ROUTING
# ============================================
[[routes]]
pattern = "container.adamic.tech"
custom_domain = true
zone_name = "adamic.tech"

# ============================================
# REQUIRED SECRETS (Set via CLI)
# ============================================
# Run these commands to set your secrets:
#
#   wrangler secret put ACCOUNT_ID
#   wrangler secret put API_KEY
#   wrangler secret put TEAM_DOMAIN
#   wrangler secret put POLICY_AUD
#
# Secret details:
# - ACCOUNT_ID: Your Cloudflare account ID
# - API_KEY: Cloudflare API token with Workers and Containers permissions
# - TEAM_DOMAIN: Cloudflare Zero Trust team domain (e.g., yourteam.cloudflareaccess.com)
# - POLICY_AUD: Access Policy AUD tag from your Access application

# ============================================
# CONTAINER DEFINITIONS (Examples)
# ============================================
# Containers are managed workloads running in the Cloudflare network.
# Each container is defined as a Durable Object with a Dockerfile.
#
# To add a container:
# 1. Create a Dockerfile in your project (e.g., containers/api/Dockerfile)
# 2. Uncomment and customize the container definition below
# 3. Deploy with: wrangler deploy
#
# Note: Containers require a separate Cloudflare Containers subscription.

# Example: API Gateway Container
# [[containers]]
# class_name = "ApiGateway"
# image = "./containers/api/Dockerfile"
# max_instances = 10

# [[durable_objects.bindings]]
# name = "API_GATEWAY"
# class_name = "ApiGateway"

# Example: Background Worker Container
# [[containers]]
# class_name = "BackgroundWorker"
# image = "./containers/worker/Dockerfile"
# max_instances = 5

# [[durable_objects.bindings]]
# name = "BACKGROUND_WORKER"
# class_name = "BackgroundWorker"

# Example: Database Proxy Container
# [[containers]]
# class_name = "DatabaseProxy"
# image = "./containers/db-proxy/Dockerfile"
# max_instances = 3

# [[durable_objects.bindings]]
# name = "DATABASE_PROXY"
# class_name = "DatabaseProxy"

# ============================================
# CONTAINER MIGRATIONS (Add when enabling containers)
# ============================================
# Uncomment when you add actual containers:
# [[migrations]]
# tag = "v2_containers"
# new_sqlite_classes = ["ApiGateway", "BackgroundWorker", "DatabaseProxy"]
