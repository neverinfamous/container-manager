# Cloudflare Container Manager - Wrangler Configuration Template
# Copy this file to wrangler.toml and customize for your Cloudflare account
#
# NOTE: This is the PRODUCTION configuration.
# For local development, use wrangler.dev.toml instead.

name = "container-manager"
main = "worker/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Smart Placement disabled for SPA - UI responsiveness priority
placement = { mode = "off" }

[build]
command = "npm run build"
cwd = "."

[assets]
directory = "dist"
binding = "ASSETS"

# ============================================
# D1 METADATA DATABASE CONFIGURATION
# ============================================
# This database stores container metadata, jobs, webhooks, and snapshots
# Create database: wrangler d1 create container-manager-metadata
# Then run: wrangler d1 execute container-manager-metadata --remote --file=worker/schema.sql
[[d1_databases]]
binding = "METADATA"
database_name = "container-manager-metadata"  # CHANGE THIS
database_id = "your-metadata-database-id"  # CHANGE THIS (from wrangler d1 create output)

# ============================================
# R2 SNAPSHOT BUCKET (OPTIONAL)
# ============================================
# R2 bucket for container configuration snapshots
# Create bucket: wrangler r2 bucket create container-manager-snapshots
[[r2_buckets]]
binding = "SNAPSHOT_BUCKET"
bucket_name = "container-manager-snapshots"  # CHANGE THIS

# ============================================
# DURABLE OBJECTS
# ============================================
# Durable Object for async snapshot operations
[[durable_objects.bindings]]
name = "SNAPSHOT_DO"
class_name = "SnapshotDO"
script_name = "container-manager"

[[migrations]]
tag = "v1_snapshot_do"
new_classes = ["SnapshotDO"]

# ============================================
# SCHEDULED ACTIONS (OPTIONAL)
# ============================================
# Cron trigger for scheduled container actions (restart, rebuild, scale)
# Runs hourly to check for and execute due scheduled actions
[triggers]
crons = ["0 * * * *"]  # Every hour at minute 0

# ============================================
# OBSERVABILITY (OPTIONAL)
# ============================================
# Enable OpenTelemetry export for traces and logs
[observability]
enabled = true

[observability.logs]
enabled = true
# Uncomment and set your log destination name from Cloudflare Dashboard
# destinations = ["your-logs-destination"]

# ============================================
# CUSTOM DOMAIN ROUTING (OPTIONAL)
# ============================================
# Option 1: Use default Workers.dev subdomain (no configuration needed)
#   Your worker will be available at: https://container-manager.<your-subdomain>.workers.dev
#
# Option 2: Use custom domain (uncomment and configure below)
# [[routes]]
# pattern = "containers.your-domain.com"  # CHANGE THIS
# custom_domain = true
# zone_name = "your-domain.com"           # CHANGE THIS

# ============================================
# REQUIRED SECRETS (Set via CLI)
# ============================================
# Run these commands to set your secrets:
#
#   wrangler secret put ACCOUNT_ID
#   wrangler secret put API_KEY
#   wrangler secret put TEAM_DOMAIN
#   wrangler secret put POLICY_AUD
#
# Secret details:
# - ACCOUNT_ID: Your Cloudflare account ID (Dashboard > Overview)
# - API_KEY: Cloudflare API token with Workers and Containers permissions
# - TEAM_DOMAIN: Cloudflare Zero Trust team domain (e.g., yourteam.cloudflareaccess.com)
# - POLICY_AUD: Access Policy AUD tag from your Access application
#
# ============================================
# LOCAL DEVELOPMENT
# ============================================
# For local development, use wrangler.dev.toml instead of this file.
# See README.md "Local Development" section for instructions.
#
# Quick start:
#   Terminal 1: npm run dev
#   Terminal 2: npx wrangler dev --config wrangler.dev.toml --local
